name: NEURON ModelDB CI

on:
  push:
    branches: [master]
  pull_request:
      branches: [ master ]
  schedule:
    # Run at 2am every day
    - cron:  '0 2 * * *'
  workflow_call:
   inputs:
      neuron_v1:
        description: Last official release (neuron) / NEURON pinned version / Azure drop (artifacts) url
        default: 'neuron'
        required: true
        type: string
      neuron_v2:
        description: Last nightly release (neuron-nightly) / NEURON pinned version / Azure drop (artifacts) url
        default: 'neuron-nightly'
        required: true
        type: string
      models_to_run:
        description: 'Empty for all models, space separated accession numbers for specific models'
        default: ''
        required: false
        type: string
      repo:
        default: 'neuronsimulator/nrn-modeldb-ci'
        type: string
        required: false
      platform:
        description: 'The platform/OS'
        default: 'ubuntu-latest'
        required: false
        type: string
      python_version:
        description: 'The Python version of the NEURON wheel'
        default: '3.9'
        required: false
        type: string

  workflow_dispatch:
    inputs:
      neuron_v1:
        description: Last official release (neuron) / NEURON pinned version / Azure drop (artifacts) url
        default: 'neuron'
        required: true
      neuron_v2:
        description: Last nightly release (neuron-nightly) / NEURON pinned version / Azure drop (artifacts) url
        default: 'neuron-nightly'
        required: true
      models_to_run:
        description: 'Empty for all models, space separated accession numbers for specific models'
        default: ''
        required: false
      platform:
        description: 'The platform/OS'
        default: 'ubuntu-latest'
        required: false
      python_version:
        description: 'The Python version of the NEURON wheel'
        default: '3.9'
        required: false

env:
  NEURON_V1: ${{ github.event.inputs.neuron_v1 || inputs.neuron_v1 || 'neuron' }}
  NEURON_V2: ${{ github.event.inputs.neuron_v2 || inputs.neuron_v2 || 'neuron-nightly' }}

jobs:
  modeldb-v1:
    name: Running with ${{ env.NEURON_V1 }}
    uses: ./.github/workflows/nrn-modeldb-ci-template.yaml@jelic/parallel_running
    with:
      neuron_version: ${{ github.event.inputs.neuron_v1 || inputs.neuron_v1 || 'neuron' }}
      models_to_run: ${{ github.event.inputs.models_to_run || inputs.models_to_run || '' }}
      platform: ubuntu-latest
      python_version: '3.9'

  modeldb-v2:
    name: Running with ${{ env.NEURON_V2 }}
    uses: ./.github/workflows/nrn-modeldb-ci-template.yaml@jelic/parallel_running
    with:
      neuron_version: ${{ github.event.inputs.neuron_v2 || inputs.neuron_v2 || 'neuron-nightly' }}
      models_to_run: ${{ github.event.inputs.models_to_run || inputs.models_to_run || '' }}
      platform: ubuntu-latest
      python_version: '3.9'

  compare:
    name: Compare results
    needs:
      - modeldb-v1
      - modeldb-v2
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts for ${{ env.NEURON_V1 }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.NEURON_V1 }}-ubuntu-latest-3.9
          path: v1

      - name: Download artifacts for ${{ env.NEURON_V2 }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.NEURON_V2 }}-ubuntu-latest-3.9
          path: v2

      - name: diffreports2html
        if: env.NEURON_V1 != env.NEURON_V2
        run: |
          diffreports2html v1/${NEURON_V1}.json v2/${NEURON_V2}.json
